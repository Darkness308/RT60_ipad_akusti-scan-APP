name: Swift Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v4
    
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
    
    - name: Cache Swift Package Manager
      uses: actions/cache@v3
      with:
        path: |
          .build
          AcoustiScanConsolidated/.build
          Modules/Export/.build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.swift', '**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
    
    - name: Build and Test Main Package
      run: |
        swift build --build-tests
        swift test

    - name: Build AcoustiScanConsolidated
      run: |
        cd AcoustiScanConsolidated
        swift build

    - name: Test AcoustiScanConsolidated
      run: |
        cd AcoustiScanConsolidated
        swift test

    - name: Build Export Module
      run: |
        cd Modules/Export
        swift build

    - name: Test Export Module
      run: |
        cd Modules/Export
        swift test